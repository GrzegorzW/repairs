{% extends "AppBundle::base.html.twig" %}

{% block title %}
    | Naprawy | Szczegóły
{% endblock %}

{% block pageContainer %}

    {% include 'AppBundle::alerts.html.twig' %}

    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-info">
                <div class="panel-heading">Klient</div>
                <ul class="list-group">
                    <li class="list-group-item"><strong>ID użytkownika:</strong>
                        {% if is_granted('ROLE_PERMISSION_USER_SECTION') %}
                            <a href="{{ path('worker_panel_user_details',{'id':repair.user.id}) }}">
                                {{ repair.user.altId }}
                            </a>
                        {% else %}
                            {{ repair.user.altId }}
                        {% endif %}
                    </li>
                    <li class="list-group-item"><strong>Imię i
                            nazwisko:</strong> {{ repair.user.name }} {{ repair.user.surname }}
                    </li>
                    <li class="list-group-item"><strong>E-mail:</strong>
                        {{ repair.user.email|default('-') }}
                    </li>
                    <li class="list-group-item"><strong>Tel:</strong>
                        {{ phone_number_format(repair.user.tel|default('-')) }}
                    </li>
                    <li class="list-group-item">
                        <button type="button" class="btn btn-info btn-sm btn-block user-invoice-data">
                            Dane do faktury
                        <span class="glyphicon glyphicon-triangle-bottom pull-right"
                              style="margin-top: 2px;"></span>
                        </button>
                    </li>
                </ul>
                <ul class="list-group user-invoice-data-body hidden">
                    <li class="list-group-item">
                        <strong>Nazwa firmy:</strong> {{ repair.user.clientCompanyName|default('-') }}
                    </li>
                    <li class="list-group-item">
                        <strong>Adres:</strong> {{ repair.user.clientCompanyAddress|default('-') }}
                    </li>
                    <li class="list-group-item">
                        <strong>Kod pocztowy:</strong> {{ repair.user.clientCompanyPostCode|default('-') }}
                    </li>
                    <li class="list-group-item">
                        <strong>Miasto:</strong> {{ repair.user.clientCompanyCity|default('-') }}
                    </li>
                    <li class="list-group-item">
                        <strong>NIP:</strong> {{ repair.user.clientCompanyNIP|default('-') }}
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <div class="panel panel-info">
                <div class="panel-heading">
                    Naprawa
                    <div class="pull-right">
                        {% if is_granted('ROLE_SUPER_ADMIN') %}
                            <button type="button" class="btn btn-danger btn-xs" data-toggle="modal"
                                    data-target="#repairChangeLocalizationModal">
                                Lokalizacja
                            </button>
                            <button type="button" class="btn btn-primary btn-xs" data-toggle="modal"
                                    data-target="#repairChangelogModal">
                                Historia
                            </button>
                        {% endif %}
                        {% if is_granted('ROLE_PERMISSION_POKWITOWANIE_CREATE') %}
                            <a href="{{ path('worker_panel_pokwitowanie_print',{'id': repair.id }) }}"
                               title="Pokwitowanie">
                                <button type="button" class="btn btn-xs btn-info">Pokwitowanie</button>
                            </a>
                        {% endif %}
                    </div>
                </div>
                <ul class="list-group">
                    <li class="list-group-item"><strong>ID naprawy: </strong> {{ repair.altId }}</li>
                    <li class="list-group-item">
                        <strong>Data przyjęcia: </strong> {{ repair.startDate | date('d.m.Y H:i:s') }}
                        ({{ repair.startLocalization.name }})
                    </li>
                    <li class="list-group-item">
                        <strong>Status:</strong>
                        <label for="status" class="sr-only">Zmiana statusu</label>
                        <select class="form-control change-status" id="status">
                            {% for status in statusesToSelect %}
                                <option value="{{ status.id }}"
                                        {% if repair.currentStatus.id == status.id %}
                                            selected
                                        {% endif %}
                                >
                                    {{ status.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </li>
                    <li class="list-group-item">
                        <strong>Naprawiający </strong>
                        <label for="repairer" class="sr-only">Naprawiający</label>
                        <select class="form-control change-repairer" id="repairer"
                                {% if
                                repair.currentStatus.id == constant('AppBundle\\Entity\\Status::STATUS_RETURNED') or not
                                is_granted("ROLE_PERMISSION_CHANGE_REPAIRER") %}
                                    disabled
                                {% endif %}
                        >
                            {% for repairer in repairersToSelect %}
                                <option value="{{ repairer.id }}"
                                        {% if repair.currentRepairer.id == repairer.id %}
                                            selected
                                        {% endif %}
                                >
                                    {{ repairer.localization.name }} | {{ repairer.name }} {{ repairer.surname }}
                                </option>
                            {% endfor %}
                        </select>
                    </li>
                    {% if is_granted('ROLE_SUPER_ADMIN') %}
                        <li class="list-group-item"><strong>Lokalizacja startowa: </strong><span
                                    class="repair-start-localization">{{ repair.startLocalization }}</span></li>
                    {% endif %}
                    <li class="list-group-item"><strong>Data zakończenia: </strong>
                        {% if repair.endDate is not null and repair.currentStatus.id == constant('AppBundle\\Entity\\Status::STATUS_RETURNED') %}
                            {{ repair.endDate | date('d.m.Y H:i:s') }}
                        {% else %}
                            -
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-info">
                <div class="panel-heading">Sprzęt</div>
                <ul class="list-group">
                    <li class="list-group-item"><strong>ID urządzenia: </strong>
                        <a href="{{ path('worker_panel_device_details', {'id': repair.device.id}) }}">{{ repair.device.altId }}</a>
                    </li>
                    <li class="list-group-item"><strong>Marka i model: </strong>
                        {{ repair.device.brand }} {{ repair.device.model }}
                    </li>
                    <li class="list-group-item"><strong>S/N: </strong> {{ repair.device.serial }}</li>
                    {% for field in repair.device.customFields %}
                        <li class="list-group-item"><strong>{{ field.customFieldTemplate.name }}
                                :</strong> {{ device_manager.getCustomFieldValueName(field) }}</li>
                    {% endfor %}
                    <li class="list-group-item"><strong>Dodatkowo: </strong>
                        {{ repair.addition|default('-') }}
                    </li>
                    <li class="list-group-item"><strong>Opis usterki: </strong> {{ repair.description }}</li>
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <div class="panel panel-info">
                <div class="panel-heading">
                    Koszty naprawy
                    {% if repair.currentStatus.id != constant('AppBundle\\Entity\\Status::STATUS_RETURNED')
                    and (is_granted('ROLE_SUPER_ADMIN') or app.user.localization == repair.startLocalization)
                    and repair.totalRepairPricingChanged %}
                        <div class="pull-right">
                            <button type="button" class="btn btn-danger btn-xs repair-pricing-acceptation-request">
                                Prześlij wycenę naprawy do klienta
                            </button>
                        </div>
                    {% endif %}
                </div>
                <div class="panel-body">
                    <div class="panel panel-default">
                        <div class="panel-heading repair-cost-approve">
                            Podsumowanie
                            {% if is_granted('ROLE_SUPER_ADMIN') %}
                                <span class="pull-right repair-cost-approved-toggle {% if repair.currentStatus.id != constant('AppBundle\\Entity\\Status::STATUS_RETURNED') %}hidden{% endif %}">
                                Zatwierdzono:
                                <label for="approved-toggle" class="sr-only">Przełącznik</label>
                                <input id="approved-toggle" type="checkbox" checked data-toggle="toggle"
                                       data-on="Tak" data-off="Nie" data-onstyle="success"
                                       data-offstyle="danger" data-size="mini">
                            </span>
                            {% endif %}
                        </div>
                        <div class="panel-body text-right">
                            {% if is_granted('ROLE_SUPER_ADMIN') or repair.currentStatus.id != constant('AppBundle\\Entity\\Status::STATUS_RETURNED') %}
                            <a data-toggle="modal" class="repair-total-price-financial-summary"
                               data-target="#editRepairPaymentModal">
                                <span class="glyphicon glyphicon-edit text-success" style="cursor: pointer;"></span></a>
                                {% endif %}
                                Metoda płatności:
                                <span class="repair-payment-method">{{ repair.paymentMethod|default('-') }}</span>
                                <br>

                            <span class="payment-label-text">
                                {% if repair.currentStatus.id == constant('AppBundle\\Entity\\Status::STATUS_RETURNED') %}
                                    Zapłacono:
                                {% else %}
                                    Kwota do zapłaty:
                                {% endif %}
                            </span>

                                {{ financialSummary.price | money_format }}<br>
                                {% if is_granted('ROLE_SUPER_ADMIN') or not repair.approved %}
                                    Koszty: {{ financialSummary.cost | money_format }}<br>
                                    <span class="glyphicon glyphicon-minus"></span>
                                    ___________________<br><br>
                                    Zarobek: {{ financialSummary.profit | money_format }}<br>
                                {% endif %}
                        </div>
                    </div>
                </div>
                {% if is_granted('ROLE_SUPER_ADMIN') or not repair.approved %}
                    <div class="table-responsive"
                         style="border-top: none">
                        <table class="table table-bordered" id="convertable-table">
                            <thead>
                            <tr>
                                <th>
                                    Autor
                                </th>
                                <th>
                                    Typ
                                </th>
                                <th>
                                    Opis
                                </th>
                                <th>
                                    Kwota
                                </th>
                                <th>
                                    Edytuj
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for cost in repairCostsAndPrices %}
                                {% if
                                is_granted('ROLE_SUPER_ADMIN') or
                                cost.localization == app.user.localization or
                                cost.costKind.type == constant('AppBundle\\Entity\\RepairCostKind::TYPE_PLUS') %}
                                    <tr class="
                                {% if app.user.localization ==  cost.repair.startLocalization %}
                                    {% if cost.localization == cost.repair.startLocalization %}
                                        {% if cost.costKind.type == constant('AppBundle\\Entity\\RepairCostKind::TYPE_PLUS') %}success{% else %}danger{% endif %}
                                    {% else %}
                                        {% if cost.costKind.type == constant('AppBundle\\Entity\\RepairCostKind::TYPE_PLUS') %}danger{% else %}foreign-entry{% endif %}
                                    {% endif %}
                                {% else %}
                                    {% if cost.localization != cost.repair.startLocalization %}
                                        {% if cost.costKind.type == constant('AppBundle\\Entity\\RepairCostKind::TYPE_PLUS') %}success{% else %}danger{% endif %}
                                    {% else %}
                                        foreign-entry
                                    {% endif %}
                                {% endif %}">
                                        <td data-title="Autor">
                                            <span tabindex="0" class="glyphicon glyphicon-info-sign text-muted"
                                                  role="button"
                                                  data-toggle="popover"
                                                  data-container="body"
                                                  data-trigger="focus hover" data-placement="bottom"
                                                  data-content="{{ cost.created | date('d.m.Y H:i:s') }} {% if is_granted('ROLE_SUPER_ADMIN') and cost.localization is not null %}Przypisano do: {{ cost.localization.name }}{% endif %}">
                                            </span>
                                            {{ cost.author.name }} {{ cost.author.surname }}
                                        </td>
                                        <td data-title="Typ">
                                            {{ cost.costKind.name }}
                                        </td>
                                        <td data-title="Opis">
                                            {{ cost.description }}
                                        </td>
                                        <td data-title="Kwota">
                                            {{ cost.price | money_format }}
                                        </td>
                                        <td data-title="Edytuj">
                                            <div class="text-center pricing-edit-button">
                                                {% if (app.user == cost.author and repair.currentStatus.id != constant('AppBundle\\Entity\\Status::STATUS_RETURNED')) or is_granted('ROLE_SUPER_ADMIN') %}
                                                    <a href="{{ path('worker_panel_repair_pricing_edit',{'id':cost.id}) }}">
                                                        <span class="glyphicon glyphicon-edit text-success"></span>
                                                    </a>
                                                {% else %}
                                                    <span class="glyphicon glyphicon-edit text-muted"></span>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            <tr id="pricingForm" class="
                                {% if repair.currentStatus.id == constant('AppBundle\\Entity\\Status::STATUS_RETURNED') and not is_granted('ROLE_SUPER_ADMIN') %}
                                    hidden
                                {% endif %}">
                                <td data-title="Autor">
                                    {{ app.user.name }} {{ app.user.surname }}
                                </td>
                                <td data-title="Typ">
                                    {{ form_start(formPricing) }}
                                    {{ form_row(formPricing.cost_kind, {'attr': {'class': 'input-sm'}}) }}
                                </td>
                                <td data-title="Opis">
                                    {{ form_row(formPricing.description, {'attr': {'class': 'input-sm', 'placeholder': 'opis*'}}) }}
                                </td>
                                <td data-title="Kwota">
                                    {{ form_widget(formPricing.price.tbbc_amount, {'attr': {'class': 'input-sm price-amount money-amount', 'placeholder': 'kwota*'}}) }}

                                    {% if form_errors(formPricing) %}
                                        <span class="help-block">
                                    <ul class="list-unstyled">
                                        <li class="text-danger">
                                            <span class="glyphicon glyphicon-exclamation-sign"></span>
                                            To pole zawiera błędy
                                        </li>
                                    </ul>
                                </span>
                                        <script>
                                            $('#pricing_price_tbbc_amount').css('border-color', '#a94442');
                                        </script>
                                    {% endif %}
                                </td>
                                <td data-title="Dodaj">
                                    <div class="text-center">
                                        <input type="submit" value="Dodaj"
                                               class="btn btn-sm btn-success"/>
                                        {{ form_end(formPricing) }}
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-info">
                <div class="panel-heading">Timeline</div>
                <div class="panel-body">
                    <div id="messages">
                        <ul class="timeline">
                            {#----TIMELINE OPIONION BEGIN----#}
                            {% if repair.opinion is not null %}
                                <li class="timeline-fullwidth opinion">
                                    <div class="timeline-panel">
                                        <div class="timeline-heading">
                                            <h4 class="timeline-title">Opinia:</h4>
                                        </div>
                                        <div class="timeline-body">
                                            <p>
                                                {{ repair.opinion | raw }}
                                            </p>
                                            <p>
                                                <small class="text-muted">{{ repair.opinionDate | date('d.m.Y H:i:s') }}</small>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="timeline-badge warning"><i
                                                class="glyphicon glyphicon-edit timeline-glyphicon"></i></div>
                                </li>
                            {% endif %}
                            {#----TIMELINE OPIONION END----#}

                            {#----MESSAGE START----#}
                            <li class="timeline-inverted">
                                <div class="timeline-badge success">
                                    <i class="glyphicon glyphicon-plus timeline-glyphicon"></i>
                                </div>
                                <div class="timeline-panel">
                                    <div class="timeline-heading">
                                        <h4 class="timeline-title">
                                            Nowa wiadomość:
                                        </h4>
                                    </div>
                                    <div class="timeline-body">
                                        {{ form_start(form) }}
                                        <div class="form-group{% if form_errors(form.content) %} has-error {% endif %}">
                                            {{ form_widget(form.content) }}
                                        </div>
                                        <div class="help-block {% if form_errors(form.content) %} has-error {% endif %}">
                                            {{ form_errors(form.content) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form_widget(form.type) }}
                                        </div>
                                        <div class="help-block col-md-10">Wiadomości nie będzie można usuwać ani
                                            edytować.
                                        </div>
                                        <div class="form-group col-md-2">
                                            {{ form_widget(form.send, {'attr': {'class': 'btn btn-sm btn-success pull-right'}}) }}
                                        </div>
                                        {{ form_end(form) }}
                                    </div>
                                </div>
                            </li>
                            {#----MESSAGE STOP----#}
                            {% for entry in timeline %}
                                {% if helper_service.instanceOf(entry, 'AppBundle\\Entity\\Message') %}
                                    {% include 'AppBundle:Timeline:message.html.twig' %}
                                {% elseif helper_service.instanceOf(entry, 'AppBundle\\Entity\\RepairersHistory') %}
                                    {% include 'AppBundle:Timeline:repairersHistory.html.twig' %}
                                {% elseif helper_service.instanceOf(entry, 'AppBundle\\Entity\\RepairStatus') %}
                                    {% include 'AppBundle:Timeline:repairStatus.html.twig' %}
                                {% elseif helper_service.instanceOf(entry, 'AppBundle\\Entity\\TotalRepairPricing') %}
                                    {% include 'AppBundle:Timeline:totalPricingRequest.html.twig' %}
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal potwierdzenie zmiany statusu -->
    <div class="modal fade" id="modalChangeStatus" tabindex="-1" role="dialog" aria-labelledby="modalChangeStatusLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="modalChangeStatusLabel">Nowy status: </h4>

                    <div class="modal-new-status"></div>
                </div>
                {% if is_granted('ROLE_PERMISSION_PUBLIC_MESSAGES') %}
                    <div class="modal-body">
                        <label for="modal-public-message">Wiadomość publiczna:</label>
                        <input type="text" class="form-control modal-public-message" id="modal-public-message">
                        {% if repair.user.email is not null %}
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" value="checkbox" id="modal-email-checkbox"
                                           class="modal-email-checkbox" checked>
                                    Dołącz tą wiadomość do e-maila potwierdzającego zmianę statusu.
                                </label>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modal-status-canceled" data-dismiss="modal">Anuluj
                    </button>
                    <button type="button" class="btn btn-success modal-status-submit" data-dismiss="modal">Zatwierdź
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal - change repairer confirmation -->
    <div class="modal fade" id="modalChangeRepairer" tabindex="-1" role="dialog"
         aria-labelledby="modalChangeRepairerLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="modalChangeRepairerLabel">Nowy naprawiający:</h4>

                    <div class="modal-new-repairer"></div>
                </div>
                <div class="modal-body">
                    <label for="modal-private-message">Notatka:</label>
                    <input type="text" class="form-control modal-private-message" id="modal-private-message">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default modal-repairer-canceled" data-dismiss="modal">Anuluj
                    </button>
                    <button type="button" class="btn btn-success modal-repairer-submit" data-dismiss="modal">Zatwierdź
                    </button>
                </div>
            </div>
        </div>
    </div>
    {#todo dla przypadku naprawy zakonczonej i niezatwierdzonej, po zmianie stanu dodaj przyciski z hiperlaczami do edycji wpisu#}

    {% if is_granted("ROLE_SUPER_ADMIN") %}

        {% set action = "Akcja" %}
        {% set data = "Dane" %}
        {% set timeStamp = "Data" %}
        {% set author = "Autor" %}

        <div class="modal fade" id="repairChangelogModal" tabindex="-1" role="dialog"
             aria-labelledby="repairChangelogModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                        <h3 class="modal-title" id="repairChangelogModal">Historia zmian</h3>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <h4>Naprawa</h4>
                            <table class="table table-bordered table-hover" id="convertable-table">
                                <thead>
                                <tr>
                                    <th>
                                        {{ action }}
                                    </th>
                                    <th>
                                        {{ data }}
                                    </th>
                                    <th>
                                        {{ timeStamp }}
                                    </th>
                                    <th>
                                        {{ author }}
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for log in repairChangelog %}
                                    <tr>
                                        <td data-title="{{ action }}">
                                            {% set message = log.action %}
                                            {{ message|trans }}
                                        </td>
                                        <td data-title="{{ data }}">
                                            {% for key, data in log.data %}
                                                {% if data is iterable %}
                                                    {% for row in data %}
                                                        {% set message = key %}
                                                        {{ message|trans }}: {{ row }}
                                                    {% endfor %}
                                                {% else %}
                                                    {% if key == "approved" %}
                                                        Wycena:
                                                        {% if data %}
                                                            Zatwierdzona
                                                        {% else %}
                                                            Niezatwierdzona
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                                <br>
                                            {% endfor %}
                                        </td>
                                        <td data-title="{{ timeStamp }}">
                                            {{ log.loggedAt | date('d.m.Y H:i:s') }}
                                        </td>
                                        <td data-title="{{ author }}">
                                            {{ log.username }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <hr>
                            <h4>Koszty naprawy</h4>
                            {% for index, priceChangelog in repairPricingChangelog %}
                                <h5>#{{ index+1 }}</h5>
                                <table class="table table-bordered table-hover" id="convertable-table">
                                    <thead>
                                    <tr>
                                        <th>
                                            {{ action }}
                                        </th>
                                        <th>
                                            {{ data }}
                                        </th>
                                        <th>
                                            {{ timeStamp }}
                                        </th>
                                        <th>
                                            {{ author }}
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for change in priceChangelog %}
                                        <tr>
                                            <td data-title="{{ action }}">
                                                {% set message = change.action %}
                                                {{ message|trans }}
                                            </td>
                                            <td data-title="{{ data }}">
                                                {% for key, data in change.data %}
                                                    {% set message = key %}
                                                    {{ message|trans }}:
                                                    {% if data is iterable %}
                                                        {% for row in data %}
                                                            {{ row }}
                                                        {% endfor %}
                                                    {% else %}
                                                        {{ data }}
                                                    {% endif %}
                                                    <br>
                                                {% endfor %}
                                            </td>
                                            <td data-title="{{ timeStamp }}">
                                                {{ change.loggedAt | date('d.m.Y H:i:s') }}
                                            </td>
                                            <td data-title="{{ author }}">
                                                {{ change.username }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <h5>Brak wycen</h5>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Zamknij</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="repairChangeLocalizationModal" tabindex="-1" role="dialog"
             aria-labelledby="repairChangeLocalizationModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                        <h3 class="modal-title" id="repairChangelogModal">Zmiana lokalizacji startowej</h3>
                    </div>
                    <form id="editRepairStartLocalizationForm">
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="repairStartLocalizationSelect">Lokalizacja <u>startowa</u></label>
                                <select type="select" id="repairStartLocalizationSelect" class="form-control"
                                        name="repairStartLocalizationSelect"
                                        required="required"
                                        data-error="Wybierz startową lokalizację.">
                                    {% for choice in localization_service.allLocalizations %}
                                        <option value="{{ choice.id }}"
                                                {% if choice == repair.startLocalization %}selected{% endif %}>
                                            {{ choice.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if repair.currentRepairer != app.user %}
                                    <span class="text-muted text-danger">
                                            Naprawa zostanie przypisana do Twojego konta.
                                        </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Anuluj</button>
                            <input type="submit" class="btn btn-success" value="Zatwierdź"/>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="modal fade" id="editRepairPaymentModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Metoda płatności</h4>
                </div>
                <form id="editRepairPayment" name="editRepairPayment">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="paymentMethodSelect" class="sr-only">Metoda płatności</label>
                            <select type="select" id="paymentMethodSelect" class="form-control"
                                    name="paymentMethodSelect"
                                    required="required"
                                    data-error="Wybierz metodę płatności.">
                                {% for choice in paymentMethods %}
                                    <option value="{{ choice.id }}"
                                            {% if repair.paymentMethod.id == choice.id %}selected{% endif %}
                                    >
                                        {{ choice.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-success" id="editTotalPriceSubmit">Zatwierdź</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% if is_granted('ROLE_WORKER') %}
        <div class="modal fade" id="workerRepairPricingAcceptationModal" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Wycena: <span id="repair-total-price-modal"></span>
                        </h4>
                    </div>
                    <div class="modal-body">
                        <ul id="repair-pricing-descriptions-modal" style="list-style-type: circle"></ul>
                        <div class="form-group">
                            <label for="workerRepairPricingAcceptationSelect">Sposób akceptacji</label>
                            <select type="select" id="workerRepairPricingAcceptationSelect" class="form-control"
                                    name="workerRepairPricingAcceptationMethod"
                                    required="required"
                                    data-error="Wybierz metodę akceptacji.">
                                {% for choice in acceptationMethods %}
                                    {% if choice.type is not constant('AppBundle\\Entity\\TotalRepairPricingResponseMethod::TYPE_APP') %}
                                        <option value="{{ choice.type }}">
                                            {{ choice.name |trans |default('Wprowadź medody akceptacji') }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Anuluj</button>
                        <button type="button" class="btn btn-success" id="workerRepairPricingAcceptationSubmit">
                            Zatwierdź
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <script>
        $(document).ready(function () {

            var currentRepairStatusId = {{ repair.currentStatus.id }};
            var repairerId = {{ repair.currentRepairer.id }};

            $(".change-status").change(function () {
                var statusName = $('.change-status option:selected').text();
                $('.modal-new-status').text(statusName);

                $('#modalChangeStatus').modal('show');
            });

            $('.modal-status-submit').click(function () {

                var selectedStatusId = $('.change-status option:selected').val();
                var message = $('.modal-public-message').val();
                var appendMessageToEmail = 0;
                var url = '{{ path('api_set_repair_statusset_repair_status',{'repair':repair.id, 'status': "plain_id"}) }}';
                url = url.replace("plain_id", selectedStatusId);

                if ($('.modal-email-checkbox').is(':checked')) {
                    appendMessageToEmail = 1;
                }

                $.ajax({
                    type: 'PATCH',
                    url: url,
                    data: {
                        message: message,
                        appendMessageToEmail: appendMessageToEmail
                    },
                    success: function (data, status, xhr) {
                        if (xhr.status == 200) {

                            $('.modal-email-checkbox').attr('checked', false);
                            $('.modal-public-message').val('');
                            var emailSendedConfirmation;

                            if (data.emailSended == 1) {
                                emailSendedConfirmation = 'Wysłano wiadomość e-mail.';
                            } else {
                                emailSendedConfirmation = null;
                            }
                            currentRepairStatusId = selectedStatusId;

                            swal("Status został zmieniony.", emailSendedConfirmation, "success");

                            if (currentRepairStatusId == {{ constant('AppBundle\\Entity\\Status::STATUS_RETURNED') }} {% if not is_granted("ROLE_PERMISSION_CHANGE_REPAIRER") %} || 1 {% endif %}) {
                                $('.change-repairer').attr('disabled', true);
                            } else {
                                $('.change-repairer').attr('disabled', false);
                            }

                            if (currentRepairStatusId == {{ constant('AppBundle\\Entity\\Status::STATUS_RETURNED') }} && {% if is_granted('ROLE_SUPER_ADMIN') %}1{% else %}0{% endif %}) {
                                $('.repair-cost-approved-toggle').removeClass('hidden');
                            } else {
                                $('.repair-cost-approved-toggle').addClass('hidden');

                            }

                            if (currentRepairStatusId == {{ constant('AppBundle\\Entity\\Status::STATUS_RETURNED') }} && {% if not is_granted('ROLE_SUPER_ADMIN') %}1{% else %}0{% endif %}) {
                                $('#pricingForm').addClass('hidden');
                                $('.pricing-edit-button').html("").html("<span class='glyphicon glyphicon-edit text-muted'></span>");
                            } else {
                                $('#pricingForm').removeClass('hidden');
                            }

                            if (currentRepairStatusId == {{ constant('AppBundle\\Entity\\Status::STATUS_RETURNED') }}) {
                                $('.payment-label-text').text('Zapłacono');
                            } else {
                                $('.payment-label-text').text('Kwota do zapłaty');
                            }

                        }
                        else {
                            swal("Wystąpił błąd.", null, "error");
                        }
                    }
                });
            });


            {% if is_granted('ROLE_SUPER_ADMIN') %}
            $('#editRepairStartLocalizationForm').submit(function (e) {

                e.preventDefault();

                $('#repairChangeLocalizationModal').modal('hide');

                var url = '{{ path('api_update_repair_start_localizationedit_repair_start_localization',{'repair':repair.id, 'localization': 12345}) }}';
                var localization = $('#repairStartLocalizationSelect').val();
                url = url.replace('12345', localization);

                $.ajax({
                    type: 'PATCH',
                    url: url,
                    success: function (data, status, xhr) {
                        if (xhr.status == 204) {
                            var localizationName = $('#repairStartLocalizationSelect option:selected').text();
                            $('.repair-start-localization').text(localizationName);
                            swal("Lokalizacja została zmieniona", null, "success");
                        }
                    },
                    error: function () {
                        swal("Wystąpiły błędy", null, "error")
                    }
                });
            });
            {% endif %}


            $('.modal-status-canceled').click(function () {
                $('.change-status').val(currentRepairStatusId);
            });

            $(".change-repairer").change(function () {
                var repairerName = $('.change-repairer option:selected').text();
                $('.modal-new-repairer').text(repairerName);

                $('#modalChangeRepairer').modal('show');

            });

            $('.modal-repairer-canceled').click(function () {
                $('.change-repairer').val(repairerId);
            });

            $(function () {
                $('[data-toggle="popover"]').popover()
            });

            $('.modal-repairer-submit').click(function () {

                var message = $('.modal-private-message').val();
                var url = '{{ path('api_change_repairerchange-repairer',{'repair':repair.id, 'newRepairer': "plain_new_repairer_id"}) }}';
                url = url.replace("plain_new_repairer_id", $('.change-repairer option:selected').val());

                $.ajax({
                    type: 'PATCH',
                    url: url,
                    data: {
                        message: message
                    },
                    success: function (data, status, xhr) {
                        if (xhr.status == 204) {
                            swal("Naprawiający został zmieniony.", null, "success");
                        }
                    },
                    error: function () {
                        swal("Wystąpiły błędy", null, "error")
                    }
                });
            });
//-----------------------------APPROVED
            {% if repair.approved %}
            $('#approved-toggle').bootstrapToggle('on');
            isApproved = true;
            {% else %}
            $('#approved-toggle').bootstrapToggle('off');
            isApproved = false;
            {% endif %}

            $('.toggle-group').click(function () {
                if ($(this).parent().hasClass('btn-danger')) {
                    $.ajax({
                        type: 'PATCH',
                        url: '{{ path('api_set_repair_cost_approvedrepair_approved',{'id':repair.id}) }}',
                        success: function (data, status, xhr) {
                            if (xhr.status == 204) {
                                swal("Wycena została zatwierdzona", null, "success");
                            }
                        },
                        error: function () {
                            $('#approved-toggle').bootstrapToggle('off');
                            swal("Wystąpiły błędy", null, "error")
                        }
                    });
                }

                if ($(this).parent().hasClass('btn-success')) {
                    $.ajax({
                        type: 'PATCH',
                        url: '{{ path('api_set_repair_cost_not_approvedrepair_not_approved',{'id':repair.id}) }}',
                        success: function (data, status, xhr) {
                            if (xhr.status == 204) {
                                swal("Wycena została anulowana", null, "error");
                            }
                        },
                        error: function () {
                            $('#approved-toggle').bootstrapToggle('on');
                            swal("Wystąpiły błędy", null, "error")
                        }
                    });
                }
            });
//-----------------------------APPROVED
        });

        $('#editRepairPayment').submit(function (e) {
            e.preventDefault();

            $('#editRepairPaymentModal').modal('hide');
            $.ajax({
                type: 'PATCH',
                data: $('#editRepairPayment').serialize(),
                url: '{{ path('api_edit_repair_payment_methodedit_repair_payment_method',{'id':repair.id}) }}',
                success: function (data, status, xhr) {
                    if (xhr.status == 204) {

                        var selectedMethod = $('#paymentMethodSelect option:selected').text();
                        $('.repair-payment-method').text(selectedMethod);

                        swal("Metoda płatności została zmieniona", null, "success");
                    }
                },
                error: function () {
                    swal("Wystąpiły błędy", null, "error")
                }
            });
        });

        $('.repair-pricing-acceptation-request').click(function () {

            $(this).attr('disabled', true);

            var url = '{{ path('api_add_worker_total_repair_pricing_requestadd_total_repair_pricing_request', {'id':12345}) }}';
            url = url.replace(12345, {{ repair.id }});

            $.ajax({
                type: 'POST',
                url: url,
                success: function (data, status, xhr) {
                    if (xhr.status == 204) {
                        swal("Wycena naprawy została przesłana do klienta", null, "success");
                        $('select.change-status').val(2);
                    }
                },
                error: function () {
                    swal("Wystąpiły błędy", null, "error")
                }
            });
        });

        $(".money-amount").inputmask({
            alias: 'numeric',
            digits: 2,
            digitsOptional: false,
            rightAlign: false
        });

        $('.user-invoice-data').click(function () {
            $('.user-invoice-data-body').toggleClass('hidden');
        });


        function showWorkerPricingAcceptationModal(id) {

            var totalPriceText = $('#repair-total-price-' + id).text();
            var descriptionsHtml = $('#repair-pricing-descriptions-' + id).html();

            $('#workerRepairPricingAcceptationSelect').attr('data-id', id);

            $('#repair-total-price-modal').text(totalPriceText);
            $('#repair-pricing-descriptions-modal').html(descriptionsHtml);

            $('#workerRepairPricingAcceptationModal').modal('show');
        }

        $('#workerRepairPricingAcceptationSubmit').click(function () {

            var pricingSelect = $('#workerRepairPricingAcceptationSelect');

            var pricingId = pricingSelect.attr('data-id');
            var acceptationMethod = pricingSelect.val();
            var acceptationMethodName = pricingSelect.text();

            var url = '{{ path('api_set_total_repair_pricing_responsetotal_repair_pricing_response', {'pricing':111111, 'responseMethod': 222222, 'pricingStatus': 333333}) }}';
            url = url.replace(111111, pricingId).replace(222222, acceptationMethod).replace(333333, '{{ constant('AppBundle\\Entity\\TotalRepairPricingStatus::TYPE_ACCEPTED') }}');

            $.ajax({
                type: 'PATCH',
                url: url,
                success: function (data, status, xhr) {
                    if (xhr.status == 204) {

                        $('#workerRepairPricingAcceptationModal').modal('hide');

                        swal("Wycena naprawy została zaakceptowana", null, "success");

                        $('select.change-status').val(8);
                        $('#confirmation-button-' + pricingId).addClass('hidden');
                        $('#pricing-glyphicon-' + pricingId).removeClass('glyphicon-remove text-danger').addClass('glyphicon-ok text-success');
                        $('.repair-pricing-acceptation-request').addClass('hidden');
                        $('#confirmation-data-' + pricingId).html(
                                'Data akceptacji: ' + moment().format("DD.MM.YYYY HH:mm:ss") +
                                '<br>' +
                                'Sposób akceptacji: ' + acceptationMethodName);
                    }
                },
                error: function () {
                    swal("Wystąpiły błędy", null, "error")
                }
            });
        });

    </script>

{% endblock %}